name: package beta

# émasteråˆ†æ”¯æäº¤ä»£ç æ—¶ï¼Œæ„å»ºæœ€æ–°æµ‹è¯•åŒ…
on:
  push:
    branches:
      - '*'
      - '!master'
  # æ·»åŠ æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:
    inputs:
      branch:
        description: 'é€‰æ‹©è¦æ„å»ºçš„åˆ†æ”¯'
        required: false
        default: 'develop'
        type: choice
        options:
          - develop
          - focus
          - master
      build_note:
        description: 'æ„å»ºè¯´æ˜ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘çš„æµ‹è¯•åŒ…æ„å»º'

jobs:
  package:
    name: Generate Beta APK
    runs-on: ubuntu-latest
    steps:
      # 1.æ‹‰å–ä»£ç 
      - name: checkout source code
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      # 2.é…ç½®JDK
      - name: set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: 11
          distribution: adopt

      # 3.è·å–ç­¾åå¯†é’¥
      - name: setup keystore
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > gradle/assemble/dandanplay.jks

      # 4.é…ç½®æ„å»ºç±»å‹
      - name: setup build type
        run: echo "BUILD_TYPE=beta" >> $GITHUB_ENV

      # æ–°å¢ï¼šæ›¿æ¢ DevelopConfigTable.kt ä¸­çš„å ä½ç¬¦
      - name: replace placeholders in DevelopConfigTable.kt
        run: |
          APP_ID=${{ secrets.DANDANPLAY_APP_ID }}
          APP_SECRET=${{ secrets.DANDANPLAY_APP_SECRET }}
          BUGLY_ID=${{ secrets.BUGLY_ID }}
          sed -i "s/{{APP_ID}}/$APP_ID/g" common_component/src/main/java/com/xyoye/common_component/config/DevelopConfigTable.kt
          sed -i "s/{{APP_SECRET}}/$APP_SECRET/g" common_component/src/main/java/com/xyoye/common_component/config/DevelopConfigTable.kt
          sed -i "s/{{BUGLY_ID}}/$BUGLY_ID/g" common_component/src/main/java/com/xyoye/common_component/config/DevelopConfigTable.kt

      # 5.æ„å»ºå®‰è£…åŒ…
      - name: assemble apk
        env:
          KEYSTORE_PASS: ${{ secrets.KEYSTORE_PASS }}
          ALIAS_NAME: ${{ secrets.ALIAS_NAME }}
          ALIAS_PASS: ${{ secrets.ALIAS_PASS }}
        run: chmod +x gradlew && ./gradlew clean assemble${{ env.BUILD_TYPE }} --stacktrace

      # 6.é…ç½®æ„å»ºç‰ˆæœ¬
      - name: setup build version
        run: |
          apk_version=`egrep -o "[0-9].[0-9].[0-9]" buildSrc/src/main/java/Versions.kt`
          short_sha=`echo ${{ github.sha }} | cut -c1-7`
          echo "BUILD_VERSION=$apk_version" >> $GITHUB_ENV
          echo "SHORT_SHA=$short_sha" >> $GITHUB_ENV

      # 7.ç§»åŠ¨æ–‡ä»¶åˆ°æ ¹ç›®å½•
      - name: move file
        run: |
          abis=(arm64-v8a armeabi-v7a universal)
          for abi in ${abis[@]}
          do
            file_name="dandanplay_v${{ env.BUILD_VERSION }}_${abi}-${{ env.BUILD_TYPE }}.apk"
            mv app/build/outputs/apk/${{ env.BUILD_TYPE }}/${file_name} $file_name
          done

      # 8.åˆ é™¤ç›¸åŒç‰ˆæœ¬çš„æ—§betaåŒ…å’Œtag
      - name: delete old beta releases and tags
        run: |
          # å®‰è£…jqå·¥å…·
          sudo apt-get update && sudo apt-get install -y jq
          
          # è·å–ç›¸åŒç‰ˆæœ¬å·çš„æ—§betaå‘å¸ƒå’Œtagï¼ˆæ’é™¤å³å°†åˆ›å»ºçš„æ–°å‘å¸ƒï¼‰
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases" > releases.json
          
          # æå–æ—§å‘å¸ƒçš„IDå’Œtagåç§°
          old_releases=$(jq -r '.[] | select(.tag_name | startswith("dandanplay-v${{ env.BUILD_VERSION }}-beta")) | "\(.id) \(.tag_name)"' releases.json | head -n -1)
          
          # åˆ é™¤æ—§å‘å¸ƒå’Œå¯¹åº”çš„tagï¼ˆä¿ç•™æœ€æ–°çš„ä¸€ä¸ªï¼‰
          echo "$old_releases" | while read -r release_id tag_name; do
            if [ ! -z "$release_id" ] && [ ! -z "$tag_name" ]; then
              echo "åˆ é™¤æ—§betaå‘å¸ƒ: $release_id"
              curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases/$release_id"
              
              echo "åˆ é™¤æ—§betaæ ‡ç­¾: $tag_name"
              curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$tag_name"
            fi
          done

      # 9.åˆ›å»ºRelease
      - name: generate release
        id: generate_release
        uses: softprops/action-gh-release@v1
        with:
          name: å¼¹å¼¹playæ¦‚å¿µç‰ˆ v${{ env.BUILD_VERSION }} Beta (${{ env.SHORT_SHA }})
          tag_name: dandanplay-v${{ env.BUILD_VERSION }}-beta-${{ github.run_number }}-${{ env.SHORT_SHA }}
          body: |
            ğŸš€ **æµ‹è¯•ç‰ˆæœ¬æ„å»º**

            **æ„å»ºåˆ†æ”¯**: ${{ github.event.inputs.branch || github.ref_name }}
            **æ„å»ºè¯´æ˜**: ${{ github.event.inputs.build_note || 'æœ€æ–°æµ‹è¯•åŒ…ï¼Œémasteråˆ†æ”¯ä»£ç æ„å»º' }}
            **æ„å»ºæ—¶é—´**: ${{ github.run_id }}
            **è§¦å‘æ–¹å¼**: ${{ github.event_name == 'workflow_dispatch' && 'æ‰‹åŠ¨è§¦å‘' || 'è‡ªåŠ¨è§¦å‘' }}
            **æäº¤SHA**: ${{ env.SHORT_SHA }}

            > è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œä»…ç”¨äºæµ‹è¯•ç›®çš„
          prerelease: true
          files: |
            dandanplay_v${{ env.BUILD_VERSION }}_arm64-v8a-${{ env.BUILD_TYPE }}.apk
            dandanplay_v${{ env.BUILD_VERSION }}_armeabi-v7a-${{ env.BUILD_TYPE }}.apk
            dandanplay_v${{ env.BUILD_VERSION }}_universal-${{ env.BUILD_TYPE }}.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
